# CarbonChain - Docker Compose
# =============================
# Multi-service orchestration for development and testing

version: '3.8'

services:
  # Main blockchain node
  node1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: carbonchain-node1
    hostname: node1
    networks:
      - carbonchain-network
    ports:
      - "9333:9333"   # P2P
      - "8000:8000"   # API
      - "8080:8080"   # Explorer
    volumes:
      - node1-data:/app/data
      - node1-logs:/app/logs
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - CARBONCHAIN_NETWORK=regtest
      - CARBONCHAIN_DATA_DIR=/app/data
      - CARBONCHAIN_LOG_LEVEL=INFO
      - CARBONCHAIN_P2P_PORT=9333
      - CARBONCHAIN_API_PORT=8000
      - CARBONCHAIN_EXPLORER_PORT=8080
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Second node for testing sync
  node2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: carbonchain-node2
    hostname: node2
    networks:
      - carbonchain-network
    ports:
      - "9334:9333"   # P2P
      - "8001:8000"   # API
      - "8081:8080"   # Explorer
    volumes:
      - node2-data:/app/data
      - node2-logs:/app/logs
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - CARBONCHAIN_NETWORK=regtest
      - CARBONCHAIN_DATA_DIR=/app/data
      - CARBONCHAIN_LOG_LEVEL=INFO
      - CARBONCHAIN_P2P_PORT=9333
      - CARBONCHAIN_API_PORT=8000
      - CARBONCHAIN_EXPLORER_PORT=8080
      - CARBONCHAIN_SEED_NODES=node1:9333
    depends_on:
      - node1
    restart: unless-stopped

  # Mining node (optional)
  miner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: carbonchain-miner
    hostname: miner
    networks:
      - carbonchain-network
    volumes:
      - miner-data:/app/data
      - miner-logs:/app/logs
    environment:
      - CARBONCHAIN_NETWORK=regtest
      - CARBONCHAIN_DATA_DIR=/app/data
      - CARBONCHAIN_LOG_LEVEL=INFO
      - CARBONCHAIN_MINING_ENABLED=true
      - CARBONCHAIN_MINING_THREADS=4
      - CARBONCHAIN_SEED_NODES=node1:9333
    command: ["carbonchain", "mine", "start", "--address", "0"]
    depends_on:
      - node1
    restart: unless-stopped

  # PostgreSQL (for advanced features)
  postgres:
    image: postgres:15-alpine
    container_name: carbonchain-postgres
    hostname: postgres
    networks:
      - carbonchain-network
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=carbonchain
      - POSTGRES_USER=carbonchain
      - POSTGRES_PASSWORD=changeme
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U carbonchain"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis (for caching)
  redis:
    image: redis:7-alpine
    container_name: carbonchain-redis
    hostname: redis
    networks:
      - carbonchain-network
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Prometheus (monitoring)
  prometheus:
    image: prom/prometheus:latest
    container_name: carbonchain-prometheus
    hostname: prometheus
    networks:
      - carbonchain-network
    ports:
      - "9090:9090"
    volumes:
      - ./deployment/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    restart: unless-stopped

  # Grafana (visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: carbonchain-grafana
    hostname: grafana
    networks:
      - carbonchain-network
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./deployment/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./deployment/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=changeme
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - prometheus
    restart: unless-stopped

  # Nginx (reverse proxy)
  nginx:
    image: nginx:alpine
    container_name: carbonchain-nginx
    hostname: nginx
    networks:
      - carbonchain-network
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deployment/nginx/carbonchain.conf:/etc/nginx/conf.d/carbonchain.conf:ro
    depends_on:
      - node1
      - node2
    restart: unless-stopped

networks:
  carbonchain-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  node1-data:
  node1-logs:
  node2-data:
  node2-logs:
  miner-data:
  miner-logs:
  postgres-data:
  redis-data:
  prometheus-data:
  grafana-data:
